<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Catalogue Solustoc ‚Äì Bijoux √† la pi√®ce</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* STYLE SOLUSTOC */
    body { font-family: Arial, sans-serif; margin: 0; background: #fff7ea; color: #222; }
    header { background: #fff7ea; text-align: center; padding: 22px 14px; }
    header img { max-width: 160px; height: auto; }
    .wrapper { width: 94%; max-width: 1100px; margin: 18px auto 40px; }
    
    /* HERO */
    .hero { background: #ffffff; border-radius: 16px; padding: 22px 18px; box-shadow: 0 0 12px rgba(0,0,0,0.08); margin-bottom: 22px; text-align: center; border: 1px solid #f2dfc8; }
    .hero h2 { margin-top: 0; font-size: 20px; font-weight: bold; color: #8d3b42; }
    .hero p { margin: 6px 0; font-size: 14px; }
    .badge-row { margin-top: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; font-size: 13px; }
    .badge { background: #f6e5c1; border-radius: 999px; padding: 5px 12px; border: 1px solid #e4d5b1; }
    
    .section-title { margin: 24px 0 10px; font-size: 19px; font-weight: bold; color: #8d3b42; }
    
    /* BARRE DE FILTRE */
    .filter-bar { margin: 10px 0 16px; background: #fff; padding: 12px; border-radius: 12px; border: 1px solid #eedfcb; box-shadow: 0 0 8px rgba(0,0,0,0.04); display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 14px; }
    .filter-bar select { padding: 8px 10px; border-radius: 8px; border: 1px solid #c9a66b; background: #fffdf8; font-size: 14px; color: #333; min-width: 200px; }

    /* GRID */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 14px; }
    .card { background: #ffffff; border-radius: 14px; box-shadow: 0 0 10px rgba(0,0,0,0.07); border: 1px solid #f3e5d2; padding: 12px 12px 14px; display: flex; flex-direction: column; height: 100%; }
    .card img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 10px; margin-bottom: 8px; background: #ddd; cursor: pointer; }
    .card h3 { font-size: 15px; margin: 4px 0 4px; font-weight: bold; min-height: 40px; color: #333; }
    .cat-label { font-size: 12px; color: #8d3b42; margin-bottom: 3px; font-weight: bold; }
    .price-line { font-size: 14px; margin: 2px 0; line-height: 1.3; }
    .price-solustoc { font-weight: bold; color: #b32121; }
    .price-public { font-size: 13px; color: #444; display:block; }
    .stock { font-size: 13px; color: #555; margin-top: 2px; }
    
    /* CONTROLES */
    .qty-row { display:flex; justify-content:center; align-items:center; gap:8px; margin-top:6px; }
    .qty-minus, .qty-plus { width: 32px; height: 32px; border-radius: 8px; font-size: 18px; border: 1px solid #ccbda3; cursor: pointer; background: #faf3e3; }
    .btn-small { margin-top: 10px; padding: 9px 10px; font-size: 14px; border-radius: 999px; border: none; background: #25D366; color: #fff; font-weight: bold; cursor: pointer; }
    
    /* PANIER */
    .cart-block { background: #ffffff; border-radius: 16px; padding: 18px 14px 16px; box-shadow: 0 0 12px rgba(0,0,0,0.06); border: 1px solid #ecdcc4; margin-top: 30px; }
    .cart-block h2 { margin-top:0; font-size:20px; text-align:center; color: #8d3b42; }
    .cart-info { font-size:13px; text-align:center; color:#555; margin-bottom:8px; }
    table.cart-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px; }
    table.cart-table th, table.cart-table td { padding: 4px 6px; border-bottom: 1px solid #eee; text-align: left; }
    .cart-total { margin-top: 10px; font-weight: bold; text-align: right; font-size: 15px; color: #333; }
    .cart-actions { margin-top: 14px; display:flex; flex-direction:column; gap:10px; }
    .btn-main { padding: 12px 14px; border-radius: 999px; border: none; font-size: 15px; font-weight: bold; cursor: pointer; color: #fff; background: #25D366; }
    .btn-main[disabled] { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { padding: 8px 12px; border-radius: 999px; border: none; font-size: 13px; cursor: pointer; background: #f0f0f0; color: #333; }
    
    footer { text-align: center; font-size: 12px; color: #777; padding: 24px 10px 28px; }
    
    /* LIGHTBOX */
    .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .lightbox img { max-width: 90%; max-height: 90%; border-radius: 10px; }
    .lightbox-close { position: fixed; top: 14px; right: 20px; font-size: 28px; color: #fff; cursor: pointer; font-weight: bold; }
    .error-msg { margin-top: 10px; font-size: 13px; color: #b00020; text-align: center; background: #ffe6e6; padding: 10px; border-radius: 8px; }
  </style>
</head>

<body>

<header>
  <img src="../img/logosbijouxfrancais.webp" alt="Les Bijoux Fran√ßais / Solustoc">
</header>

<div class="wrapper">
  <section class="hero">
    <h2>Bijoux de Mimi ‚Äì Achat √† la pi√®ce pour revendeurs</h2>
    <p>S√©lectionnez les r√©f√©rences, ajoutez au panier et commandez via WhatsApp.</p>
    <p><strong>Livraison offerte d√®s 200 ‚Ç¨ TTC.</strong></p>
    <div class="badge-row">
      <span class="badge">üíé Qualit√© boutique</span>
      <span class="badge">üì¶ Stock r√©el</span>
      <span class="badge">üá´üá∑ Exp√©dition France</span>
    </div>
  </section>

  <h2 class="section-title">Catalogue</h2>

  <div class="filter-bar">
    <label for="filter-category">Cat√©gorie :</label>
    <select id="filter-category">
      <option value="">Chargement...</option>
    </select>
  </div>

  <div id="sheet-error" class="error-msg" style="display:none;"></div>

  <section id="products" class="grid">
    <p style="text-align:center; width:100%;">Chargement des produits...</p>
  </section>

  <section class="cart-block" id="cart-block">
    <h2>Votre s√©lection</h2>
    <div class="cart-info">Minimum conseill√© pour livraison offerte : 200 ‚Ç¨</div>
    <div id="cart-content"></div>
    <div class="cart-actions">
      <button id="btn-whatsapp" class="btn-main" disabled>üì≤ Envoyer via WhatsApp</button>
      <button id="btn-clear" class="btn-secondary">üóëÔ∏è Vider</button>
    </div>
  </section>
</div>

<footer>Solustoc ‚Ä¢ Grossiste bijoux</footer>

<div class="lightbox" id="lightbox">
  <span class="lightbox-close" id="lightbox-close">√ó</span>
  <img id="lightbox-img" src="" alt="">
</div>

<script>
  // CONFIGURATION
  const PHOTO_BASE = "../photo/"; 
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTeb1HY3fqUcP26tcQ_crdY2PIIyjT_73TakK1neuc0cxwq-QMyChF2w5Q5kYSkmd14GRSGwYeZCION/pub?output=csv";

  // DATA
  const produits = [];
  let filteredProduits = [];
  let cart = [];

  // PARSER CSV ROBUSTE (G√®re les guillemets et virgules dans les textes)
  function CSVToArray(strData, strDelimiter) {
    strDelimiter = (strDelimiter || ",");
    var objPattern = new RegExp(
      (
        "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
        "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
        "([^\"\\" + strDelimiter + "\\r\\n]*))"
      ),
      "gi"
    );
    var arrData = [[]];
    var arrMatches = null;
    while (arrMatches = objPattern.exec(strData)) {
      var strMatchedDelimiter = arrMatches[1];
      if (strMatchedDelimiter.length && strMatchedDelimiter !== strDelimiter) {
        arrData.push([]);
      }
      var strMatchedValue;
      if (arrMatches[2]) {
        strMatchedValue = arrMatches[2].replace(new RegExp("\"\"", "g"), "\"");
      } else {
        strMatchedValue = arrMatches[3];
      }
      arrData[arrData.length - 1].push(strMatchedValue);
    }
    return arrData;
  }

  // PRIX
  function parsePrix(str) {
    if (!str) return 0;
    // Accepte format 12,50 ou 12.50
    const clean = str.toString().replace(/[^0-9.,]/g, "").replace(",", ".");
    const val = parseFloat(clean);
    return isNaN(val) ? 0 : val;
  }

  function formatPrix(val) {
    return val.toLocaleString("fr-FR", { style: "currency", currency: "EUR" });
  }

  // CHARGEMENT
  async function loadProduitsFromSheet() {
    const errBox = document.getElementById("sheet-error");
    try {
      const res = await fetch(SHEET_CSV_URL);
      if (!res.ok) throw new Error("Erreur HTTP " + res.status);
      const csvText = await res.text();

      // D√©tection automatique du s√©parateur (, ou ;)
      const firstLine = csvText.split('\n')[0];
      const separator = firstLine.includes(';') ? ';' : ',';
      
      console.log("S√©parateur d√©tect√© :", separator);

      // Utilisation du parser robuste
      const data = CSVToArray(csvText, separator);
      
      if (!data || data.length < 2) throw new Error("Fichier vide ou illisible");

      // Nettoyage des ent√™tes
      const headers = data[0].map(h => h.trim().toLowerCase());
      console.log("Colonnes :", headers);

      // Mapping
      const getIdx = (keywords) => headers.findIndex(h => keywords.some(k => h.includes(k)));
      const idxTitre      = getIdx(["nom", "titre"]);     
      const idxStock      = getIdx(["stock", "quantit√©"]);
      const idxPrixPublic = getIdx(["public"]);
      const idxPrixSolus  = getIdx(["solustoc", "revendeur"]);
      const idxImage      = getIdx(["image", "photo"]);
      const idxCategorie  = getIdx(["cat", "√©gorie"]);

      if (idxTitre === -1) throw new Error("Colonne Nom introuvable");
      if (idxImage === -1) throw new Error("Colonne Image introuvable");

      let idCounter = 1;
      produits.length = 0;

      // Parcours des donn√©es
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (row.length < headers.length) continue; // ligne incompl√®te

        const titre = (row[idxTitre] || "").trim();
        if (!titre) continue;

        const stock = parseInt((row[idxStock] || "0").replace(/\D/g, ""), 10) || 0;
        const prixPublic = parsePrix(row[idxPrixPublic]);
        const prixSolustoc = parsePrix(row[idxPrixSolus]);
        const image = (row[idxImage] || "").trim();
        const categorie = (row[idxCategorie] || "Divers").trim();

        produits.push({
          id: idCounter++,
          nom: titre,
          stock,
          prixPublic,
          prixSolustoc,
          image,
          categorie
        });
      }

      console.log(produits.length + " produits charg√©s.");
      generateFilters();
      filteredProduits = [...produits];
      errBox.style.display = "none";
      renderProduits();

    } catch (e) {
      console.error(e);
      errBox.textContent = "Probl√®me technique : " + e.message;
      errBox.style.display = "block";
    }
  }

  // RESTE DU CODE (FILTRES, RENDU, PANIER...)
  function generateFilters() {
    const cats = [...new Set(produits.map(p => p.categorie).filter(c => c))].sort();
    const select = document.getElementById("filter-category");
    let html = `<option value="">Toutes les cat√©gories (${produits.length})</option>`;
    cats.forEach(c => html += `<option value="${c}">${c}</option>`);
    select.innerHTML = html;
  }

  function applyFilters() {
    const cat = document.getElementById("filter-category").value;
    filteredProduits = produits.filter(p => !cat || p.categorie === cat);
    renderProduits();
  }
  document.getElementById("filter-category").addEventListener("change", applyFilters);

  function renderProduits() {
    const container = document.getElementById("products");
    if (!filteredProduits.length) {
      container.innerHTML = `<p style="grid-column:1/-1; text-align:center;">Aucun produit trouv√©.</p>`;
      return;
    }
    container.innerHTML = filteredProduits.map(p => {
      const imgSrc = PHOTO_BASE + p.image;
      return `
        <div class="card">
          <img src="${imgSrc}" alt="${p.nom}" 
               onerror="this.src='https://via.placeholder.com/300?text=Image+introuvable'"
               onclick="openLightbox('${imgSrc}')">
          <div class="cat-label">${p.categorie}</div>
          <h3>${p.nom}</h3>
          <div class="price-line">
             <span class="price-solustoc">Prix : ${formatPrix(p.prixSolustoc)}</span><br>
             <span class="price-public">PV conseill√© : ${formatPrix(p.prixPublic)}</span>
          </div>
          <p class="stock">En stock : ${p.stock}</p>
          <div class="qty-row">
            <button class="qty-minus" onclick="changeQty(${p.id}, -1)">‚àí</button>
            <span id="qty-${p.id}" class="qty-value">1</span>
            <button class="qty-plus" onclick="changeQty(${p.id}, 1)">+</button>
          </div>
          <button class="btn-small" onclick="addToCart(${p.id})">Ajouter</button>
        </div>`;
    }).join("");
  }

  window.changeQty = function(id, delta) {
    const el = document.getElementById("qty-" + id);
    if (!el) return;
    let v = parseInt(el.textContent, 10) + delta;
    if (v < 1) v = 1;
    el.textContent = v;
  };

  window.addToCart = function(id) {
    const qty = parseInt(document.getElementById("qty-" + id).textContent, 10);
    const p = produits.find(x => x.id === id);
    if (!p) return;
    const exist = cart.find(x => x.id === id);
    if (exist) exist.qty += qty;
    else cart.push({ ...p, qty });
    renderCart();
  };

  function renderCart() {
    const box = document.getElementById("cart-content");
    const btn = document.getElementById("btn-whatsapp");
    if (!cart.length) {
      box.innerHTML = `<p style="text-align:center; font-size:13px; color:#555;">Votre panier est vide.</p>`;
      btn.disabled = true;
      return;
    }
    const total = cart.reduce((acc, i) => acc + (i.prixSolustoc * i.qty), 0);
    box.innerHTML = `
      <table class="cart-table">
        <tr><th>Produit</th><th>Qt√©</th><th>Total</th></tr>
        ${cart.map(i => `
          <tr><td>${i.nom}</td><td>${i.qty}</td><td>${formatPrix(i.prixSolustoc * i.qty)}</td></tr>
        `).join("")}
      </table>
      <p class="cart-total">Total HT : ${formatPrix(total)}</p>
    `;
    btn.disabled = false;
  }

  document.getElementById("btn-clear").onclick = () => { cart = []; renderCart(); };

  document.getElementById("btn-whatsapp").onclick = () => {
    if (!cart.length) return;
    let msg = "üõçÔ∏è *Commande Solustoc*\n\n";
    cart.forEach(i => msg += `‚Ä¢ ${i.nom} (x${i.qty})\n`);
    const total = cart.reduce((acc, i) => acc + (i.prixSolustoc * i.qty), 0);
    msg += `\nüí∞ *Total Solustoc : ${formatPrix(total)}*`;
    window.open("https://wa.me/33756923323/?text=" + encodeURIComponent(msg), "_blank");
  };

  window.openLightbox = function(src) {
    document.getElementById("lightbox-img").src = src;
    document.getElementById("lightbox").style.display = "flex";
  };
  document.getElementById("lightbox-close").onclick = () => {
    document.getElementById("lightbox").style.display = "none";
  };

  loadProduitsFromSheet();
  renderCart();
</script>
</body>
</html>
